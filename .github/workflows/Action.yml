name: Apply to Main repo
on:
  push:
    branches: [main]

jobs:
  push_changes:
    runs-on: windows-latest
    steps:
      - name: Checkout (with ww2ogg.exe in your repo)
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: choco install ffmpeg -y

      - name: Clone and update repo
        shell: pwsh
        run: |
          git clone https://github.com/NowhereArchive/NowhereAudios2.git
          cd NowhereAudios2
          Copy-Item "$env:GITHUB_WORKSPACE\vgmstream-cli.exe" .\
          
          $vgmstream = "$PWD\vgmstream-cli.exe"
          if (!(Test-Path $vgmstream)) {
            Write-Host "❌ vgmstream-cli.exe not found!"
            exit 1
          }

          Get-ChildItem -Recurse -Filter "*.wem" | ForEach-Object {
            $wemFile = $_.FullName
            $baseName = $wemFile -replace '\.wem$', ''
            $oggFile = "$baseName.ogg"
            $aacFile = "$baseName.aac"
            
            Write-Host "Processing: $wemFile"
            & $vgmstream -o "$oggFile" "$wemFile"
            
            if (Test-Path $oggFile) {
              ffmpeg -i "$oggFile" -c:a aac -b:a 192k "$aacFile" -y
              
              if (Test-Path $aacFile) {
                Remove-Item $wemFile, $oggFile
                Write-Host "✅ Converted: $aacFile"
              }
            }
          }
          
          git config user.name "NowhereArchive"
          git config user.email "178385478+NowhereArchive@users.noreply.github.com"
          git add .
          if (git diff --cached --quiet) {
            Write-Host "No changes to commit."
          } else {
            git commit -m "Convert WEM to AAC"
            git push --force https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/NowhereArchive/NowhereAudios2.git HEAD:main
          }
