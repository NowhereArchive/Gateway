name: Apply to Main repo
on:
  push:
    branches: [main]

jobs:
  push_changes:
    runs-on: windows-latest
    steps:
      - name: Checkout (with vgmstream-cli.exe in your repo)
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: choco install ffmpeg -y

      - name: Clone and update repo
        shell: pwsh
        run: |
          git clone https://github.com/NowhereArchive/NowhereAudios2.git
          cd NowhereAudios2

          # Copy vgmstream-cli.exe from workflow repo

          $vgmstream = "..\vgmstream-cli.exe"

          if (!(Test-Path $vgmstream)) {
            Write-Host "❌ vgmstream-cli.exe not found at $vgmstream"
            exit 1
          }

          Write-Host "Using vgmstream at: $vgmstream"
          & $vgmstream --version

          # Convert all WEM files
          Get-ChildItem -Recurse -Filter "*.wem" | ForEach-Object {
            $wemFile = $_.FullName
            $baseName = $wemFile -replace '\.wem$', ''
            $oggFile = "$baseName.ogg"
            $aacFile = "$baseName.aac"

            Write-Host "Processing: $wemFile"
            & $vgmstream "$wemFile" -o "$oggFile"

            if (Test-Path $oggFile) {
              ffmpeg -i "$oggFile" "$aacFile"
              if (Test-Path $aacFile) {
                Remove-Item $wemFile, $oggFile
                Write-Host "✅ Converted: $aacFile"
              }
            } else {
              Write-Host "❌ Failed to convert: $wemFile"
            }
          }

          git config user.name "NowhereArchive"
          git config user.email "178385478+NowhereArchive@users.noreply.github.com"

          # Point to new repo
          git remote set-url origin https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/NowhereArchive/NowhereAudios3.git
          git add .
          git commit -m "Convert WEM to AAC" || echo "No changes to commit"
          git push -u origin main --force
